name: CI

on: [push, pull_request]

jobs:
  main:
    strategy:
      fail-fast: false
      matrix:
        c-compiler: [gcc, clang]

        qcbor-version: [master, dev ]

        config:
        # OpenSSL 1.1.1 (Ubuntu 22.04)
        - os-image: ubuntu-latest
          crypto-provider: OpenSSL

        # OpenSSL 3.0 (Ubuntu 22.04)
        - os-image: ubuntu-latest
          crypto-provider: OpenSSL
        
        - os-image: ubuntu-latest
          crypto-provider: MbedTLS
          crypto-provider-version: 'v2.28.0'
          crypto-provider-extra: ''
          crypto-provider-build-extra: ''
        
        - os-image: ubuntu-latest
          crypto-provider: MbedTLS
          crypto-provider-version: 'v3.1.0'
          crypto-provider-extra: ''
          crypto-provider-build-extra: ''

        - os-image: ubuntu-latest
          crypto-provider: MbedTLS
          crypto-provider-version: 'v3.4.0'
          crypto-provider-extra: ''
          crypto-provider-build-extra: ''

        - os-image: ubuntu-latest
          crypto-provider: MbedTLS
          crypto-provider-version: 'v3.4.0'
          crypto-provider-extra: ''
          crypto-provider-build-extra: 'python3 scripts/config.py set MBEDTLS_ECP_RESTARTABLE'

        - os-image: ubuntu-latest
          crypto-provider: Test

    name: ${{ matrix.config.crypto-provider }} ${{ matrix.config.crypto-provider-version }} • ${{ matrix.c-compiler }} • ${{ matrix.config.container }} ${{ matrix.qcbor-version }}

    runs-on: ${{ matrix.config.os-image }}

    steps:
    - uses: actions/checkout@v3

    - name: Install OpenSSL
      if: matrix.config.crypto-provider == 'OpenSSL'
      run: sudo apt-get install -y libssl-dev

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Install Conan
      run: pip install --upgrade conan

    - name: Detect Conan profile
      run: conan profile detect --force

    - name: Install mbedTLS with Conan (inline)
      shell: bash
      run: |
        conan install \
          --requires=mbedtls/3.5.2 \
          --output-folder=build \
          --build=missing \
          -g CMakeDeps \
          -g CMakeToolchain \
          -o mbedtls/*:enable_psa=True \
          -s build_type=Debug

    - name: Fetch QCBOR
      uses: actions/checkout@v3
      with:
        repository: laurencelundblade/QCBOR
        ref: ${{ matrix.qcbor-version }}
        path: QCBOR

    - name: Configure QCBOR
      shell: bash
      run: |
        cd QCBOR
        cmake -S . -B qcbor-build 

    - name: build QCBOR
      shell: bash
      run: |
        cd QCBOR
        cmake --build qcbor-build

    - name: Install QCBOR
      shell: bash
      run: |
        cd QCBOR
        cmake --install qcbor-build --prefix "$GITHUB_WORKSPACE/install" 

    - name: Configure t_cose
      shell: bash
      run: |
        cmake -S . -B build \
          -DBUILD_TESTS=ON -DBUILD_EXAMPLES=ON \
          -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake \
          -DCRYPTO_PROVIDER=${{ matrix.config.crypto-provider }} \
          -DCMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/install \
          -DCMAKE_BUILD_TYPE=Debug \
          --debug-find-pkg=MbedTLS \
          ${{ matrix.config.crypto-provider-extra }}

    - name: Build t_cose
      run: |
        set -ex
        cmake --build build --verbose

    - name: Run examples
      run: build/t_cose_examples

    - name: Run tests
      if: matrix.config.crypto-provider == 'MbedTLS' &&
          matrix.config.crypto-provider-version == 'v3.4.0' &&
          matrix.config.crypto-provider-build-extra == ''
      # This Mbed TLS version has the option of restartable ECP, however it is
      # not turned on. In this case the restartable testcase should fail.
      #run: build/t_cose_test | grep 'restart_test_2_step FAILED'
      run: build/t_cose_test 

    - name: Run tests
      if: ${{ ! ( matrix.config.crypto-provider == 'MbedTLS' &&
              matrix.config.crypto-provider-version == 'v3.4.0' &&
              matrix.config.crypto-provider-build-extra == '' ) }}
      run: build/t_cose_test

  msvc:
    name: msvc • windows-latest
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        crypto: [ Test, OpenSSL, MbedTLS ]
    
    env:
      ARCH: x64

    steps:
      - uses: actions/checkout@v4

      # Optional: ensures Dev Cmd environment; the VS generator usually finds MSVC without this,
      # but keeping it makes detection deterministic.
      - name: Set up MSVC DevCmd
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ env.ARCH }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Conan
        run: pip install --upgrade conan

      - name: Detect Conan profile
        run: conan profile detect --force

      - name: Install mbedTLS with Conan (inline)
        shell: bash
        run: |
          conan install \
            --requires=mbedtls/3.5.2 \
            --output-folder=build \
            --build=missing \
            -g CMakeDeps \
            -g CMakeToolchain \
            -s compiler=msvc \
            -s compiler.runtime=dynamic \
            -o mbedtls/*:enable_psa=True \
            -s build_type=Debug

      - name: Fetch QCBOR Win
        uses: actions/checkout@v3
        with:
          repository: laurencelundblade/QCBOR
          ref: better-cmake
          path: QCBOR

      - name: Configure QCBOR Win
        shell: bash
        run: |
          cd QCBOR
          ARCH="${{ env.ARCH }}"
          cmake -S . -B qcbor-build -G "Visual Studio 17 2022" -A "$ARCH" 

      - name: build QCBOR Win
        shell: bash
        run: |
          cd QCBOR
          cmake --build qcbor-build 

      - name: Install QCBOR Win
        shell: bash
        run: |
          cd QCBOR
          cmake --install qcbor-build --prefix "$GITHUB_WORKSPACE/install" --config Debug

      - name: Install OpenSSL with vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: '**/vcpkg.json'

      - name: Config t_cose
        shell: bash
        run: |
          cmake -S . -B build \
          -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/install" \
          -DBUILD_TESTS=ON  -DBUILD_EXAMPLES=ON \
          -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake \
          -DCRYPTO_PROVIDER=${{ matrix.crypto }} 

      - name: Build t_cose
        run: cmake --build build --config Debug
        shell: bash

      - name: Run tests
        shell: pwsh
        run: |
          $exe = "build/Debug/t_cose_test.exe verify_multi_test"
          if (!(Test-Path $exe)) {
            Write-Error "Test binary not found: $exe"
          }
          & $exe
